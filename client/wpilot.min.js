var WPilotClient=function(){function h(a){this.options=a;this.socket=this.player=this.world=this.sound=this.input=this.viewport=null;this.message_log=[];this.gui={hud:null,scoreboard:null,warmupnotice:null,netstat:null,fps:null,messages:null,prompt:null};this.admin_password=null;this.netstat={start_time:null,frequence:0.01,last_update:0,last_received:0,bytes_received:0,bytes_sent:0,bps_in:0,bps_out:0,peek_in:0,peek_out:0,messages_received:0,messages_sent:0,mps_in:0,mps_out:0};this.state=r;this.server_state=
null;this.is_connected=this.handshaked=!1;this.disconnect_reason=null;this.last_r=this.current_r=0;this.onconnect=function(){};this.ondisconnect=function(){};this.log("Welcome to WPilot "+s)}function m(){var a=new cParticleSystem;a.active=!1;a.position=Vector.create(0,12);a.positionRandom=Vector.create(0,0);a.gravity=Vector.create(0.01,0.01);a.speed=1.5;a.lifeSpan=10;a.size=1;a.sizeRandom=1;a.angle=90;a.angleRandom=15;a.maxParticles=60;a.init();this.particles=a}function j(){this.active=!1;this.value=
0}function t(a){var b=new cParticleSystem;b.active=!0;b.position=Vector.create(0,0);b.positionRandom=Vector.create(3,3);b.startColour=[123,180,255,1];b.finishColour=[59,116,191,0];b.startColourRandom=[80,20,20,0];b.finishColourRandom=[60,10,10,0.1];b.gravity=Vector.create(0.01,0.01);b.sharpness=60;b.speed=1;b.size=1.5;b.sizeRandom=1;b.maxParticles=120;b.duration=0.8;b.lifeSpan=1;b.lifeSpanRandom=1;b.init();this.ship_size=this.alpha=0;this.pos=a;this.particles=b;this.is_done=!1}function u(a,b,c){var d=
SHIP_WIDTH/2,e=SHIP_HEIGHT/2;this.pieces=[[0,-(e/3),d/2,e/2,b,Math.random()],[-(d/2),e/4,d/2,e/2,b,Math.random()],[d/2,e/4,d/2,e/2,b,Math.random()],[0,e/4,d/2,e/2,b-270,Math.random()]];this.lifetime=1.5;this.pos=a;this.vel=c;this.angle=b;this.is_done=!1}function v(a){var b=new cParticleSystem;b.active=!0;b.position=Vector.create(0,0);b.positionRandom=Vector.create(3,3);b.gravity=Vector.create(0.01,0.01);b.sharpness=60;b.size=1.5;b.sizeRandom=1;b.maxParticles=150;b.speed=1;b.duration=1;b.lifeSpan=
5;b.lifeSpanRandom=5;b.init();this.pos=a;this.particles=b;this.is_done=!1}function n(a,b,c){this.pos=a;this.color=b;this.text=c;this.value=0;this.is_done=!1}function w(a,b,c){this.alpha=0;this.color=c;this.pos=a;this.size=b;this.is_done=!1}function x(a){this.pos=a||[0,0];this.alpha=0;this.visible=!0;this.world=this.me=null}function y(a,b,c){this.pos=a||[0,0];this.alpha=0;this.visible=!0;this.buffer=b;this.options=c}function z(a,b){this.pos=a||[0,0];this.alpha=0;this.visible=!1;this.stats=b||null}
function A(a,b){this.pos=a||[0,0];this.alpha=0;this.visible=!0;this.stats=b||null}function B(a){this.pos=a||[0,0];this.alpha=0;this.visible=!0;this.pulse=0;this.me=this.world=null}function k(a){this.pos=a;this.margin=this.table_height=this.table_width=this.size=null;this.alpha=0;this.visible=!1;this.pulse=0;this.me=this.world=null}function l(a){this.pos=a;this.size=null;this.alpha=0;this.visible=!1;this.buffer=""}function E(a){switch(a){case POWERUP_SPREAD:return F;case POWERUP_RAPID:return G;case POWERUP_RICO:return H}}
function I(a){switch(a){case POWERUP_SPREAD:return"Spread fire";case POWERUP_RAPID:return"Rapid fire";case POWERUP_RICO:return"Ricochet ammo"}}function C(a,b,c){a.beginPath();a.moveTo(0,-c);a.lineTo(b,c);a.lineTo(-b,c);a.lineTo(0,-c);a.fill()}function i(a,b,c,d,e,f){a.textAlign=e||"left";a.fillText&&a.fillText(d,b,c,f||0)}function o(a,b){var c=a.viewport;return 1-distance_between(c.camera.midpoint,b)/c.w}function p(a){var b=[],c;for(c in a.players)b.push(a.players[c]);b.sort(function(a,b){return a.score==
b.score?0:a.score>b.score?-1:1});for(a=b.length;a--;)b[a].rank=a+1;return b}function D(a,b){var c=parseInt(a/(60*b)),d=0>c?0:parseInt(c/60),c=0>c?0:c-60*d;return d+":"+(10>c?"0"+c:c)}var s="1.2",K={1:"255,176,0",2:"51,182,255",3:"172,48,224",4:"230,21,90",5:"166,219,0",6:"125,142,22",7:"244,52, 0",8:"199,244,136",9:"227,111,160",10:"63,140,227",11:"227,126,76",12:"134,213,227"},q="Boba Fett,Han Solo,Luke Skywalker,Princess Leia,R2-D2,C-3PO,Chewbacca,Darth Vader,Lando,Yoda,Teboo,Admiral Ackbar".split(","),
L=["bold","11px","Arial"],r=0,F="230,21,90",G="166,219,0",H="51,182,255",M={ship_spawn:[3,["sound/ship_spawn"]],ship_die:[3,["sound/ship_die"]],ship_thrust:[6,["sound/ship_thrust"]],bullet_spawn:[8,["sound/ship_fire_1","sound/ship_fire_2","sound/ship_fire_3"]],powerup_spawn:[3,["sound/powerup_spawn"]],powerup_die:[2,["sound/powerup_1_die"]]},J={name:"Usage: /name NEW_NAME",rate:"Usage: /rate RATE",fps:"Usage: /fps",netstat:"Usage: /netstat",ready:"Usage: /ready",sv_password:"Usage: /sv_password PASSWORD",
sv_kick:"Usage: /sv_kick PLAYER_NAME REASON",sv_map:"Usage: /sv_map PATH_TO_MAP",sv_start:"Usage: /sv_start",sv_restart:"Usage: /sv_restart",sv_warmup:"Usage: /sv_warmup"},q={rate:5E3,name:q[Math.floor(Math.random()*q.length)],rotation_speed:6,rotation_acc:0.5,bg_sound_enabled:!0,sfx_sound_enabled:!0,sound_bg_volume:0.4,sound_prefix:"/",log_max_messages:6,log_msg_lifetime:5E3,log_console:!0,bindings:{ready:82,scoreboard:83,rotate_west:37,rotate_east:39,thrust:38,shoot:32,shield:40,prompt:13}};h.prototype.log=
function(a,b){var c=this.message_log,d=get_time()+this.options.log_msg_lifetime;20<c.length&&c.shift();c.push({text:a,time:d,disposed:!1,color:b||"255, 255, 255"});this.options.log_console&&window.console&&console.log(a)};h.prototype.exec=function(){N.call(null,[this].concat(Array.prototype.slice.call(arguments)))};h.prototype.chat=function(a){2==this.state&&this.post_control_packet([OP_CLIENT_SAY,200<a.length?a.substr(0,200):a])};h.prototype.set_world=function(a){null!=a&&(a.client=this,this.viewport.set_camera_pos(vector_div(a.size,
2)));this.world=a;this.gui.hud.world=a;this.gui.scoreboard.world=a;this.gui.warmupnotice.world=a};h.prototype.set_viewport=function(a){var b=this.gui,c=this;a&&(b.hud=new x([a.w/2,a.h/2]),b.netstat=new z([6,12],this.netstat),b.fps=new A([a.w-6,12],a),b.messages=new y([6,a.h-2],this.message_log,this.options),b.scoreboard=new k([0,0]),b.scoreboard.set_size([a.w,a.h]),b.warmupnotice=new B([a.w/2,a.h-50]),b.prompt=new l([40,a.h-40]),b.prompt.set_size([a.w-80,26]),b.prompt.oncommand=function(){c.exec.apply(c,
arguments)},b.prompt.onchat=function(){c.chat.apply(c,arguments)},a.ondraw=function(d){var e=c.world,f=c.player,g=g;f&&!f.dead&&a.set_camera_pos(f.entity.pos);e&&(e.draw(a),g=e.tick);for(var i in b)(e=b[i],f=e.is_visible(),e.alpha&&(d.save(),d.globalAlpha=e.alpha,d.translate(e.pos[0],e.pos[1]),e.draw(d,g),d.restore()),f&&1>e.alpha)?e.alpha=1<e.alpha+0.2?1:e.alpha+0.2:!f&&0<e.alpha&&(e.alpha=0>e.alpha-0.2?0:e.alpha-0.2)});this.viewport=a};h.prototype.set_input=function(a){this.input=a};h.prototype.set_sound=
function(a){a&&(a.init_sfx(M),a.init_bg("sound/background"));this.sound=a};h.prototype.set_player=function(a){a&&(a.is_me=!0,this.log('You are now known as "'+a.name+'"...'));this.player=a;this.gui.hud.me=a;this.gui.scoreboard.me=a;this.gui.warmupnotice.me=a};h.prototype.set_server_state=function(a){a.no_players!=a.max_players?(this.server_state=a,this.log("Recived server state, now joining game..."),this.post_control_packet([OP_CLIENT_CONNECT,s])):this.log("Server is full")};h.prototype.set_state=
function(a){switch(a){case 1:this.log("Server found, now joining game...");this.onconnect();break;case 2:this.log("Joined server "+this.socket.url+"...");this.post_control_packet([OP_CLIENT_JOIN,{name:this.options.name,rate:this.options.rate,dimensions:[this.viewport.w,this.viewport.h]}]);break;case r:this.log("You where disconnected from server "+this.disconnect_reason?"(Reason: "+this.disconnect_reason+").":""),this.socket=null,this.handshaked=this.is_connected=!1,this.player=this.world=null,this.message_log=
[],this.stop_gameloop(),this.ondisconnect(this.disconnect_reason)}this.state=a};h.prototype.process_user_input=function(a,b){var c=this.gui,d=this.player,e=this.input;e.toggle("prompt")&&(e.onkeypress=(c.prompt.visible=!c.prompt.visible)?function(a){c.prompt.handle_key_stroke(a)}:null);if(!c.prompt.visible&&(c.scoreboard.visible=!!e.on("scoreboard"),e.toggle("ready")&&this.post_game_packet([OP_CLIENT_SET,"ready"]),!d.dead&&d.entity.visible)){var f=0,g=d.entity.angle;e.on("thrust")&&(f|=THRUST);e.on("shield")&&
(f|=SHIELD);e.on("shoot")&&(f|=SHOOT);d.is(THRUST)&&0==parseInt(1E3*a)%10&&this.sound.play("ship_thrust",0.05);e.on("rotate_west")?(-1!=this.last_r&&(this.last_r=-1,this.current_r=0),this.current_r>-this.options.rotation_speed&&(this.current_r-=this.options.rotation_acc),g+=b*this.current_r):e.on("rotate_east")?(1!=this.last_r&&(this.last_r=1,this.current_r=0),this.current_r<this.options.rotation_speed&&(this.current_r+=this.options.rotation_acc),g+=b*this.current_r):(this.last_r=-1,this.current_r=
0);if(f!=d.action||g!=d.entity.angle)g>Math.PI?g=-Math.PI:g<-Math.PI&&(g=Math.PI),d.action=f,d.entity.angle=g,this.post_game_packet([OP_CLIENT_STATE,f,g])}};h.prototype.start_gameloop=function(a){var b=this,a=new GameLoop(a);a.ontick=function(a,d){b.process_user_input(a,d);b.world.update(a,d)};a.ondone=function(a,d){b.update_netstat(a,d)};this.viewport.set_autorefresh(!0);this.netstat.start_time=this.netstat.last_update=this.netstat.last_received=get_time();a.start();b.gameloop=a;this.sound.playbg(this.options.sound_bg_volume);
return a};h.prototype.stop_gameloop=function(){this.gameloop&&(this.gameloop.kill(),this.gameloop.ontick=null,this.gameloop=this.gameloop.ondone=null)};h.prototype.join=function(a){var b=this;b.is_connected||(b.disconnect_reason="Unknown reason",this.log("Trying to join server at "+a+"..."),b.socket=io.connect(a),b.socket.url=a,b.socket.on("connect",function(){b.is_connected=!0;b.set_state(1);b.socket.emit("open");setTimeout(function(){b.socket.emit("data",[OP_REQ_SERVER_INFO])},100)}),b.socket.on("data",
function(a){switch(a[0]){case PING_PACKET:b.socket&&b.socket.emit("data",[PING_PACKET]);break;case GAME_PACKET:if(!b.world)break;var d=a[1];if(b.netstat.start_time){var e=get_time();b.netstat.last_received&&(b.netstat.last_received=e);b.netstat.last_received=e;b.netstat.bytes_received+=JSON.stringify(a).length;b.netstat.messages_received+=1}for(a=0;a<d.length;a++)b.world.process_world_packet(d[a]);break;default:O([a,b])}}),b.socket.on("disconnect",function(){b.set_state(r)}))};h.prototype.leave=function(a){this.disconnect_reason=
a;this.socket.emit("close",packet)};h.prototype.post_game_packet=function(a){a=[GAME_PACKET,a];this.netstat.start_time&&(this.netstat.bytes_sent+=a.length,this.netstat.messages_sent+=1);this.socket.emit("data",a)};h.prototype.post_control_packet=function(a){this.socket.emit("data",a)};h.prototype.update_netstat=function(){var a=this.netstat;if(a.start_time){var b=get_time();if(1E3<=b-a.last_update){var c=b-a.last_update-1E3,d=(b-a.start_time)/1E3+c/1E3,e=a.frequence,f=1-a.frequence;a.last_update=
b+c;a.bps_in=e*a.bps_in+f*a.bytes_received/d;a.bps_out=e*a.bps_out+f*a.bytes_sent/d;a.mps_in=e*a.mps_in+f*a.messages_received/d;a.mps_out=e*a.mps_out+f*a.messages_sent/d;a.peek_in=a.bps_in>a.peek_in?a.bps_in:a.peek_in;a.peek_out=a.bps_out>a.peek_out?a.bps_out:a.peek_out}}};var O=match([[OP_SERVER_INFO,Object],_],function(a,b){b.set_server_state(a)},[[OP_WORLD_DATA,Object,Object],_],function(a,b,c){var d=new World(!1);d.build(a,b);c.log("World data loaded...");c.set_world(d);c.set_state(2)},[[OP_WORLD_STATE,
Number,Object,Array,Array],_],function(a,b,c,d,e){e.world.set_state(b,c,d);e.set_player(e.world.players[a]);e.start_gameloop(e.world.tick)},[[OP_WORLD_RECONNECT],_],function(a){a.set_world(null);a.stop_gameloop()},[[OP_DISCONNECT_REASON,String],_],function(a,b){b.disconnect_reason=a},[[OP_SERVER_EXEC_RESP,String],_],function(a,b){b.log(a)},function(a){console.log("Unhandled message");console.log(a[0])}),N=match([_,"name",String],function(a,b){a.post_game_packet([OP_CLIENT_SET,"name",b])},[_,"ready"],
function(a){a.post_game_packet([OP_CLIENT_SET,"ready"])},[_,"fps"],function(a){a.gui.fps.visible=!a.gui.fps.visible},[_,"netstat"],function(a){a.gui.netstat.visible=!a.gui.netstat.visible},[_,"rate",String],function(a,b){var c=parseInt(b);0<c&&(a.post_control_packet([OP_CLIENT_SET,"rate",c]),a.log('Setting "rate" is now '+c))},[_,"sv_password",String],function(a,b){a.admin_password=b},[_,"sv_kick",String,String],function(a,b,c){var d=a.admin_password;d?a.post_control_packet([OP_CLIENT_EXEC,d,"kick",
b,c]):a.log("You need to set sv_password in order to send admin commands")},[_,"sv_map",String],function(a,b){var c=a.admin_password;c?a.post_control_packet([OP_CLIENT_EXEC,c,"map",b]):a.log("You need to set sv_password in order to send admin commands")},[_,"sv_warmup"],function(a){var b=a.admin_password;b?a.post_control_packet([OP_CLIENT_EXEC,b,"warmup"]):a.log("You need to set sv_password in order to send admin commands")},[_,"sv_start"],function(a){var b=a.admin_password;b?a.post_control_packet([OP_CLIENT_EXEC,
b,"start"]):a.log("You need to set sv_password in order to send admin commands")},[_,"sv_restart"],function(a){var b=a.admin_password;b?a.post_control_packet([OP_CLIENT_EXEC,b,"restart"]):a.log("You need to set sv_password in order to send admin commands")},function(a){var b=a[0],a=a[1];J[a]?b.log(J[a],"255, 215, 0"):b.log("Command not found","255, 215, 0")});Player.prototype.on_before_init=function(){this.angle=0;this.rank=1;this.is_me=!1;this.death_cause=0;this.killed_by=null};Player.prototype.on_after_init=
function(){this.color=K[this.id]||"255, 255, 255"};World.prototype.on_before_init=function(){this.anim_id_count=1;this.animations=[];this.ranked_player_list=[];this.winner_names=null};World.prototype.on_update=function(a,b){for(var c=this.animations,d=c.length;d--;){var e=c[d];e.anim.update(a,b);e.anim.is_done&&(e.callback(),c.splice(d,1))}};World.prototype.on_after_state_set=function(){this.ranked_player_list=p(this)};World.prototype.on_player_join=function(a){this.client.log('Player "'+a.name+'" joined the world...');
this.ranked_player_list=p(this)};World.prototype.on_player_leave=function(a,b){this.client.log('Player "'+a.name+'" disconnected. Reason: '+b);this.ranked_player_list=p(this)};World.prototype.on_player_spawn=function(a,b){this.client.sound.play("ship_spawn",a.is_me?1:o(this.client,b));this.play_animation(new t(b),function(){a.entity&&(a.entity.visible=!0)});a.is_me&&(a.entity.is_me=!0,this.client.viewport.set_camera_pos(b))};World.prototype.on_player_fire=function(a){this.client.sound.play("bullet_spawn",
a.is_me?1:o(this.client,a.entity.pos))};World.prototype.on_player_died=function(a,b,c,d){var e=a.is_me?1:o(this.client,b.pos);a.death_cause=c;a.killed_by=d;this.client.sound.play("ship_die",e);this.play_animation(new u(b.pos,b.angle,b.vel));this.play_animation(new v(b.pos));d&&d.is_me&&d.entity&&this.play_animation(new n(d.entity.pos,"255, 215, 0","+1"));text=a.is_me?c==DEATH_CAUSE_KILLED?"You where killed by "+d.name:"You took your own life!":c==DEATH_CAUSE_KILLED?a.name+" was killed by "+(d.is_me?
"you":d.name)+".":a.name+" killed him self.";this.client.log(text);this.ranked_player_list=p(this)};World.prototype.on_player_ready=function(a){this.client.log(a.is_me?"You are now ready":'Player "'+a.name+" is ready")};World.prototype.on_player_name_changed=function(a,b,c){this.client.log('"'+c+'" is now known as "'+b+'"');a.is_me&&(this.client.options.name=b)};World.prototype.on_round_state_changed=function(a,b){switch(a){case ROUND_STARTING:this.client.viewport.set_camera_pos(vector_div(this.size,
2));break;case ROUND_FINISHED:for(var c=[],d=0;d<b.length;d++)c.push(this.players[b[d]].name);this.winner_names=c.join(",")}};World.prototype.on_powerup_spawn=function(a){this.client.sound.play("powerup_spawn",o(this.client,a.pos));this.play_animation(new w(a.pos,a.size,a.color),function(){a.visible=!0})};World.prototype.on_powerup_die=function(a,b){b.is_me&&this.client.sound.play("powerup_die");this.play_animation(new n(a.pos,E(a.powerup_type),I(a.powerup_type)))};World.prototype.on_after_init=function(){this.PACKET_HANDLERS=
{};this.PACKET_HANDLERS[OP_ROUND_STATE]=this.set_round_state;this.PACKET_HANDLERS[OP_PLAYER_CONNECT]=this.add_player;this.PACKET_HANDLERS[OP_PLAYER_DISCONNECT]=this.remove_player;this.PACKET_HANDLERS[OP_PLAYER_INFO]=this.update_player_info;this.PACKET_HANDLERS[OP_PLAYER_SPAWN]=this.spawn_player;this.PACKET_HANDLERS[OP_PLAYER_DIE]=this.kill_player;this.PACKET_HANDLERS[OP_PLAYER_FIRE]=this.fire_player_canon;this.PACKET_HANDLERS[OP_PLAYER_STATE]=this.update_player_state;this.PACKET_HANDLERS[OP_PLAYER_SAY]=
this.player_say;this.PACKET_HANDLERS[OP_POWERUP_SPAWN]=this.spawn_powerup;this.PACKET_HANDLERS[OP_POWERUP_DIE]=this.kill_powerup};World.prototype.play_animation=function(a,b){var c=this.anim_id_count++;this.animations.push({id:c,anim:a,callback:b||function(){}});return c};World.prototype.process_world_packet=function(a){var b=a.shift(),c=this.PACKET_HANDLERS[b];c?c.apply(this,a):console.log(b)};World.prototype.update_player_info=function(a,b,c,d){var e=this.players[a];b&&(e.ping=e.ping?parseInt(0.5*
e.ping+0.5*b):b);c&&this.set_player_ready(a);d&&this.set_player_name(a,d)};World.prototype.update_player_state=function(a,b,c,d){a=this.players[a];if(a.entity&&(b&&(a.entity.pos_sv=b),a.is_me||(a.entity.angle=c),!a.is_me))a.action=d};World.prototype.player_say=function(a,b){var c=this.players[a];this.client.log(c.name+": "+b,c.color)};World.prototype.draw=function(a){var b=this.entities,c=this.animations,d=a.ctx;this.draw_grid(d,a.camera);for(var e in b){var f=b[e];if(!f.is_me&&intersects(f.get_bounds(),
a.get_camera_box())){var g=a.translate(f.pos);d.save();d.translate(g[0],g[1]);f.draw(d);d.restore()}}for(b=c.length;b--;)e=c[b],g=a.translate(e.anim.pos),d.save(),d.translate(g[0],g[1]),e.anim.draw(d),d.restore()};World.prototype.draw_grid=function(a,b){var c,d=b.pos[0],e=b.pos[1],f=b.size[0],g=b.size[1];a.save();a.fillStyle="black";a.strokeStyle="rgba(255,255,255,0.2)";a.lineWidth=0.5;a.beginPath();for(c=0>d?-d:250-d%250;c<f;)a.moveTo(c,0),a.lineTo(c,g),c+=250;for(c=0>e?-e:250-e%250;c<g;)a.moveTo(0,
c),a.lineTo(f,c),c+=250;a.stroke();0>d&&a.fillRect(0,0,-d,g);d+f>this.size[0]&&a.fillRect(this.size[0]-d,0,d+f-this.size[0],g);0>e&&a.fillRect(0,0,f,-e);e+g>this.size[1]&&a.fillRect(0,this.size[1]-e,f,e-g+this.size[1]);a.restore()};Ship.prototype.on_before_init=function(){this.is_me=this.visible=!1};Ship.prototype.on_after_init=function(){this.animations={thrust:new m,shield:new j};this.pos_sv=this.pos};Ship.prototype.world_update=function(a,b){this.move(a,b);if(0.01<Math.abs(this.pos[0]-this.pos_sv[0])||
0.01<Math.abs(this.pos[1]-this.pos_sv[1]))this.pos=vector_add(this.pos,vector_div(vector_sub(this.pos_sv,this.pos),10));this.update(a,b)};Ship.prototype.update=function(a,b){this.animations.shield.set_active(this.is(SHIELD));this.animations.thrust.set_active(this.is(THRUST));for(var c in this.animations)this.animations[c].update(a,b)};Ship.prototype.destroy=function(a,b){this.destroyed=!0;this.death_cause=a;this.destroyed_by=b;this.animations.die.set_active(!0)};Ship.prototype.draw=function(a){if(this.visible){var b=
this.size[0]/2,c=this.size[1]/2;a.rotate(this.angle);a.strokeStyle="white";a.lineWidth=1;a.fillStyle="white";C(a,b,c);for(var d in this.animations)a.save(),this.animations[d].draw(a),a.restore();this.is_me||(a.rotate(-this.angle),a.font=L,a.fillStyle="rgb("+this.player.color+")",i(a,0,this.size[1]+10,this.player.name,"center",100))}};Bullet.prototype.on_before_init=function(){this.visible=!0};Bullet.prototype.draw=function(a){var b=this.size[0],c=this.size[1];a.rotate(this.angle);a.fillStyle="white";
a.fillRect(-(b/2),-(c/2),b,c)};Wall.prototype.draw=function(a){var b=this.size[0],c=this.size[1],d=0.2*Math.min(b,c),e=0.8*Math.min(b,c);a.save();a.fillStyle="black";a.fillRect(0,0,b,c);a.fillStyle="red";switch(this.o){case "n":a.fillRect(e,c-d,b-2*e,d);break;case "e":a.fillRect(0,e,d,c-2*e);break;case "s":a.fillRect(e,0,b-2*e,d);break;case "w":a.fillRect(b-d,e,d,c-2*e)}a.restore()};Block.prototype.draw=function(a){var b=this.connectors,c=this.size;a.strokeStyle="rgba(200, 20, 20, 0.4)";a.lineWidth=
2;a.fillStyle="rgba(200, 20, 20, 0.1)";a.fillRect(0,0,this.size[0],this.size[1]);b&BLOCK_CONNECTOR_NORTH||(a.beginPath(),a.moveTo(0,0),a.lineTo(c[0],0),a.stroke());b&BLOCK_CONNECTOR_EAST||(a.beginPath(),a.moveTo(c[0],0),a.lineTo(c[0],c[1]),a.stroke());b&BLOCK_CONNECTOR_SOUTH||(a.beginPath(),a.moveTo(0,c[1]),a.lineTo(c[0],c[1]),a.stroke());b&BLOCK_CONNECTOR_WEST||(a.beginPath(),a.moveTo(0,0),a.lineTo(0,c[1]),a.stroke());(b&(BLOCK_CONNECTOR_EAST|BLOCK_CONNECTOR_NORTH))==(BLOCK_CONNECTOR_EAST|BLOCK_CONNECTOR_NORTH)&&
(a.beginPath(),a.moveTo(c[0]-BLOCK_SPACING,0),a.lineTo(c[0],0),a.lineTo(c[0],BLOCK_SPACING),a.stroke());(b&(BLOCK_CONNECTOR_EAST|BLOCK_CONNECTOR_SOUTH))==(BLOCK_CONNECTOR_EAST|BLOCK_CONNECTOR_SOUTH)&&(a.beginPath(),a.moveTo(c[0],c[1]-BLOCK_SPACING),a.lineTo(c[0],c[1]),a.lineTo(c[0]-BLOCK_SPACING,c[1]),a.stroke());(b&(BLOCK_CONNECTOR_WEST|BLOCK_CONNECTOR_NORTH))==(BLOCK_CONNECTOR_WEST|BLOCK_CONNECTOR_NORTH)&&(a.beginPath(),a.moveTo(0+BLOCK_SPACING,0),a.lineTo(0,0),a.lineTo(0,BLOCK_SPACING),a.stroke());
(b&(BLOCK_CONNECTOR_WEST|BLOCK_CONNECTOR_SOUTH))==(BLOCK_CONNECTOR_WEST|BLOCK_CONNECTOR_SOUTH)&&(a.beginPath(),a.moveTo(0+BLOCK_SPACING,c[1]),a.lineTo(0,c[1]),a.lineTo(0,c[1]-BLOCK_SPACING),a.stroke())};Powerup.prototype.on_after_init=function(){this.inner_radius=this.size[0]/1.8;this.pulse=0;this.color=E(this.powerup_type);this.ch=I(this.powerup_type)[0];this.visible=!1};Powerup.prototype.update=function(a,b){this.visible&&(this.pulse+=6*b,20<this.pulse&&(this.pulse=0))};Powerup.prototype.draw=function(a){if(this.visible){var b=
this.color,c=1-8*this.pulse/100,d=0.7-5*this.pulse/100,e=this.inner_radius,f=e+this.pulse;a.beginPath();a.lineWidth=1.5;a.strokeStyle="rgba("+b+", 0.8)";a.arc(0,0,e,0,Math.PI/180,!0);a.stroke();a.beginPath();a.lineWidth=1;a.strokeStyle="rgba("+b+", "+d+")";a.arc(0,0,f,0,Math.PI/180,!0);a.stroke();a.font="7px Arial";a.fillStyle="rgba("+b+", "+c+")";i(a,1,2,this.ch,"center",e)}};m.prototype.set_active=function(a){this.particles.active=a};m.prototype.update=function(a,b){this.particles.update(65*b)};
m.prototype.draw=function(a){this.particles.render(a)};j.prototype.set_active=function(a){if(a!=this.active&&(this.active=a)&&0>=this.value)this.value=0.01};j.prototype.update=function(a,b){var c=this.value;this.active&&0.7>c?c+=5*b:0<c&&(c-=5*b);this.value=c};j.prototype.draw=function(a){0<this.value&&(a.beginPath(),a.strokeStyle="rgba(255, 255, 255,"+this.value+")",a.arc(0,0,20,0,Math.PI/180,!0),a.stroke())};t.prototype.update=function(a,b){this.ship_size=this.alpha+=2*b;0.5<=this.ship_size&&(this.ship_size=
0.5);this.particles.update(5*b);0==this.particles.particleCount&&(this.is_done=!0)};t.prototype.draw=function(a){this.particles.render(a);a.save();a.fillStyle="rgba(255, 255, 255, "+this.alpha+")";C(a,SHIP_WIDTH*this.ship_size,SHIP_HEIGHT*this.ship_size);a.restore()};u.prototype.update=function(a,b){if(1.5>this.lifetime)if(0<this.lifetime){for(var c=this.pieces,d=c.length;d--;){var e=c[d];e[4]+=b*8*e[5]}c=this.vel[0]/1.05;d=this.vel[1]/1.05;this.pos=[this.pos[0]+c*b,this.pos[1]-d*b];this.vel[0]=c;
this.vel[1]=d}else this.is_done=!0;this.lifetime-=b};u.prototype.draw=function(a){var b=this.pieces,c=b.length;for(a.fillStyle="rgba(255, 255, 255, "+this.lifetime+")";c--;){var d=b[c];a.save();a.rotate(d[4]);a.translate(d[0],d[1]);C(a,d[2],d[3]);a.restore()}};v.prototype.update=function(a,b){this.particles.update(5*b);0==this.particles.particleCount&&(this.is_done=!0)};v.prototype.draw=function(a){this.particles.render(a)};n.prototype.update=function(a,b){this.value+=60*b;50<=this.value&&(this.is_done=
!0)};n.prototype.draw=function(a){var b=6+this.value;a.fillStyle="rgba("+this.color+", "+(1-5*this.value/100)+")";a.font="bold "+b+"px Arial";i(a,0,0,this.text,"center")};w.prototype.update=function(a,b){this.alpha+=b;0.8<=this.alpha&&(this.is_done=!0)};w.prototype.draw=function(a){var b=this.color,c=this.alpha,d=this.size[0]/1.8;a.beginPath();a.lineWidth=1.5;a.strokeStyle="rgba("+b+", "+c+")";a.arc(0,0,d,0,Math.PI/180,!0);a.stroke()};x.prototype.is_visible=function(){return!this.world||!this.me||
this.me.dead||!this.me.entity?!1:this.visible};x.prototype.draw=function(a,b){var c=this.me,d=this.world,e=2*Math.PI*c.energy/100;a.beginPath();a.lineWidth=22;a.strokeStyle="rgba(255, 255, 255, 0.06)";a.arc(0,0,95,-Math.PI/2,-e-Math.PI/2,!0);a.stroke();a.beginPath();a.lineWidth=1;a.strokeStyle="rgba(255, 255, 255, 0.08)";a.arc(0,0,108,0,Math.PI/180,!0);a.stroke();c.has_powerup(POWERUP_SPREAD)&&(e=c.powerup_timers[POWERUP_SPREAD],e=(e.end-b)/(e.end-e.start),e*=2*Math.PI,a.beginPath(),a.lineWidth=6,
a.strokeStyle="rgba("+F+", 0.1)",a.arc(0,0,81,3*Math.PI/2,e-Math.PI/2,!1),a.stroke());c.has_powerup(POWERUP_RAPID)&&(e=c.powerup_timers[POWERUP_RAPID],e=(e.end-b)/(e.end-e.start),e*=2*Math.PI,a.beginPath(),a.lineWidth=6,a.strokeStyle="rgba("+G+", 0.1)",a.arc(0,0,75,3*Math.PI/2,e-Math.PI/2,!1),a.stroke());c.has_powerup(POWERUP_RICO)&&(e=c.powerup_timers[POWERUP_RICO],e=(e.end-b)/(e.end-e.start),e*=2*Math.PI,a.beginPath(),a.lineWidth=6,a.strokeStyle="rgba("+H+", 0.1)",a.arc(0,0,69,3*Math.PI/2,e-Math.PI/
2,!1),a.stroke());d.r_state==ROUND_RUNNING&&1<d.ranked_player_list.length&&(d=d.ranked_player_list[0]==c?c.score-d.ranked_player_list[1].score:c.score-d.ranked_player_list[0].score,a.font="bold 18px Arial",a.fillStyle="rgba(255, 255, 255, 0.3)",i(a,0,240,0<d?"In lead +"+d:0>d?"Behind "+d:"Tied for the lead","center"));c.entity&&(a.save(),c.entity.draw(a),a.restore(),a.rotate(c.entity.angle),a.fillStyle="rgba(255, 255, 255, 0.8)",a.fillRect(0,-110,1,6))};y.prototype.is_visible=function(){return null==
this.buffer?!1:this.visible};y.prototype.draw=function(a){var b=this.buffer,c=b.length,d=0,e=get_time(),f=this.options.log_max_messages;a.textBaseline="top";for(a.font=" 11px Arial";c--&&b.length-1-c<f;){var g=b[c];if(!g.disposed){var h=g.time>e?0.8:0.8+(0-(e-g.time)/1E3);0.02>h&&(g.disposed=!0);a.fillStyle="rgba("+g.color+","+h+")";i(a,0,d-=12,g.text,"left")}}};z.prototype.is_visible=function(){return!this.stats.start_time?!1:this.visible};z.prototype.draw=function(a){var b=this.stats;a.font=" 9px Arial";
a.fillStyle="rgb(255, 255, 255)";var c=round_number(b.bps_in/1024,2),d=round_number(b.bps_out/1024,2),e=round_number(b.mps_in,2),b=round_number(b.mps_out,2);i(a,0,0,"Netstat: in: "+c+"kb/s, out: "+d+"kb/s, in: "+e+"/mps, out: "+b+"/mps","left")};A.prototype.is_visible=function(){return this.visible};A.prototype.draw=function(a){a.font=" 9px Arial";a.fillStyle="rgb(255, 255, 255)";i(a,0,0,"FPS count: "+parseInt(this.stats.average_fps),"right")};B.prototype.is_visible=function(){return!this.world||
this.world.r_state!=ROUND_WARMUP||!this.me||this.me.dead?!1:this.visible};B.prototype.draw=function(a){var b=this.world,c=this.me,d="",e=!1;1==b.no_players?d="Waiting for more players to join...":c.ready?(d=Math.ceil(0.6*b.no_players-b.no_ready_players),d="Waiting for "+d+" player"+(1==d?"":"s")+" to press ready"):(d="Press (r) when ready",e=!0);a.font="bold 13px Arial";a.fillStyle="rgb(255, 215, 0)";e&&(e=Math.abs(Math.sin(this.pulse+=0.08)),0.1>e&&(e=0.1),a.fillStyle="rgba(255, 215, 0,"+e+")");
i(a,0,0,d,"center")};k.prototype.is_visible=function(){return this.visible||this.world&&this.me&&this.me.dead||!1};k.prototype.set_size=function(a){this.size=a;this.table_width=0.8*this.size[0];this.margin=(this.size[0]-this.table_width)/2;this.table_height=this.size[1]-this.margin};k.prototype.draw=function(a){var b=this.world,c=this.me,d=this.margin,e=this.margin;if(b){var f="",g=null,h=0;a.fillStyle="rgba(0, 0, 0, 0.4)";a.fillRect(0,0,this.size[0],this.size[1]);a.fillStyle="rgb(255, 215, 0)";switch(b.r_state){case ROUND_WARMUP:f=
"Warmup round";break;case ROUND_STARTING:f="Prepare your self, game starts in...";break;case ROUND_RUNNING:c.dead?(f=c.death_cause==DEATH_CAUSE_KILLED?"You where killed by "+c.killed_by.name:"You took your own life",h=c.respawn_time-b.tick,g="Respawn in "+D(h,b.delta)+" sec"):f="Your rank is "+c.rank+" of "+b.no_players;break;case ROUND_FINISHED:f="Round won by "+b.winner_names+", next map starts in..."}a.font="bold 16px Arial";i(a,d,e,f,"left");b.r_timer&&(h=b.r_state==ROUND_RUNNING?b.r_timer:b.r_timer-
b.tick,i(a,d+this.table_width,e,D(h,b.delta),"right"));g&&(a.font="bold 13px Arial",i(a,this.size[0]/2,this.table_height+this.margin/2,g,"center"));a.font="bold 11px Arial";i(a,d,e+=20,b.map_name+", round limit: "+b.rules.round_limit);i(a,d+this.table_width,e,b.no_players+" / "+b.max_players+" players","right");i(a,d+42,e+=60,"Player name");i(a,d=this.margin+this.table_width,e,"Score","right",50);i(a,d-=50,e,"Kills","right",50);i(a,d-=50,e,"Deaths","right",50);i(a,d-=50,e,"Time","right",50);i(a,d-
50,e,"Ping","right",50);b=b.ranked_player_list;c=0;d=this.margin;for(e+=10;c<b.length&&e<this.table_height;)f=b[c++],this.draw_row(a,[d,e],f),e+=28}};k.prototype.draw_row=function(a,b,c){var d=b[0],e=b[1],f=c.name+(this.world.r_state==ROUND_RUNNING&&c.dead?" (dead)":""),g=c.score,h=c.deaths+"("+c.suicides+")",k=c.kills,l=D(this.world.tick-c.time,this.world.delta),m=c.ping||"--",j=c.rank;a.textBaseline="top";switch(this.world.r_state){case ROUND_WARMUP:case ROUND_STARTING:g=k=h=l="--";a.font=" 13px Arial";
c.ready?(a.fillStyle="rgba(102, 255, 0, 0.4)",j="\u2714"):(a.fillStyle="rgba(110, 110, 110, 0.4)",j="\u2716");break;case ROUND_RUNNING:case ROUND_FINISHED:a.font="bold 13px Arial",a.fillStyle="rgba("+c.color+", 0.4)"}a.fillRect(d,e,24,22);d+=6;e+=3;a.fillStyle="rgb(255, 255, 255)";i(a,d+6,e,j,"center");a.font="bold 13px Arial";a.fillStyle=c.is_me?"rgb(255, 255, 255)":"rgb(78, 78, 78)";i(a,d+36,e,f);i(a,d=b[0]+this.table_width,e,g,"right",50);i(a,d-=50,e,k,"right",50);i(a,d-=50,e,h,"right",50);i(a,
d-=50,e,l,"right",50);i(a,d-50,e,m,"right",50)};l.prototype.is_visible=function(){return this.visible};l.prototype.set_size=function(a){this.size=a;this.prompt_width=0.8*this.size[0];this.margin=(this.size[0]-this.prompt_width)/2;this.onchat=this.oncommand=null};l.prototype.handle_key_stroke=function(a){switch(a){case 8:this.buffer=this.buffer.substr(0,this.buffer.length-1);break;case 13:if(1<this.buffer.length&&"/"==this.buffer[0]){for(var b=[],c="",d=!1,e=1;e<this.buffer.length;e++)a=this.buffer[e],
'"'==a?d=!d:" "==a&&!d?(b.push(c),c=""):c+=a;c.length&&b.push(c);this.oncommand.apply(null,b)}else if(this.buffer.length)this.onchat(this.buffer);this.buffer="";break;default:this.buffer+=String.fromCharCode(a)}};l.prototype.draw=function(a){a.strokeStyle="rgb(255, 215, 0)";a.fillStlye="rgba(0, 0, 0, 0.8)";a.fillRect(this.margin,0,this.size[0]-2*this.margin,this.size[1]);a.strokeRect(this.margin,0,this.size[0]-2*this.margin,this.size[1]);a.strokeStyle=null;a.fillStyle="rgb(255, 215, 0)";a.font="bold 13px Arial";
a.textBaseline="top";var b=this.size[0]-2*this.margin-8,c=a.measureText(this.buffer+"|").width,c=c>b?this.margin+4-(c-b):this.margin+4;a.beginPath();a.rect(this.margin+4,4,b,this.size[1]-8);a.clip();i(a,c,4,this.buffer+"|")};h.options=q;h.version=s;return h}();function get_time(){return(new Date).getTime()};